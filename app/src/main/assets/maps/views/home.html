<template>

    <div class="page page-home">
        <div class="navbar navbar-style-1" style="box-shadow: rgb(177 91 16 / 39%) -1px 1px 8px 0px">
            <div class="navbar-inner">
                <a href="#" class="link icon-only panel-open" data-panel="left">
                    <svg width="27" height="18" viewBox="0 0 27 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="0.5" y="0.833344" width="21" height="2.33333" rx="1" fill="#222222"/>
                        <rect x="6" y="7.83334" width="21" height="2.33333" rx="1" fill="#222222"/>
                        <rect x="0.5" y="14.8333" width="21" height="2.33334" rx="1" fill="#222222"/>
                    </svg>
                </a>
                <div class="title">
                    MOS
                </div>
                <div class="right">
                    <a href="/notification" class="link"> 
                        <div class="bell-icon">
                            <i class="fa fa-circle color-theme-orange active"></i>
                            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 32 32">
                                <path d="M27.868,25.5,26,22.234V14A10,10,0,0,0,6,14v7.128L4.081,25.606A1,1,0,0,0,5,27h6.1a5,5,0,0,0,9.8,0H27a1,1,0,0,0,.868-1.5ZM16,29a3,3,0,0,1-2.816-2h5.632A3,3,0,0,1,16,29ZM6.517,25l1.4-3.272a.994.994,0,0,0,.081-.4V14a8,8,0,0,1,16,0v8.5a.993.993,0,0,0,.132.5l1.145,2Z"/>
                                <path d="M14,3h4a1,1,0,0,0,0-2H14a1,1,0,0,0,0,2Z"/>
                            </svg>
                        </div>
                    </a>

                    <a href="/check_profil/" class="link"> 
                        <div class="bell-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M15.7 11.717C16.6839 10.9476 17.4031 9.89041 17.7575 8.69276C18.1118 7.49511 18.0836 6.21673 17.6767 5.03589C17.2698 3.85506 16.5046 2.83063 15.4877 2.10546C14.4708 1.38028 13.253 0.990524 12.004 0.990524C10.755 0.990524 9.53719 1.38028 8.52031 2.10546C7.50342 2.83063 6.73819 3.85506 6.33131 5.03589C5.92443 6.21673 5.89619 7.49511 6.25053 8.69276C6.60487 9.89041 7.32413 10.9476 8.308 11.717C6.44917 12.4566 4.85467 13.7363 3.73027 15.391C2.60587 17.0457 2.00318 18.9994 2 21V22C2 22.2652 2.10536 22.5196 2.29289 22.7071C2.48043 22.8946 2.73478 23 3 23H21C21.2652 23 21.5196 22.8946 21.7071 22.7071C21.8946 22.5196 22 22.2652 22 22V21C21.9975 19.0003 21.3959 17.0473 20.273 15.3927C19.1501 13.7381 17.5573 12.4579 15.7 11.717ZM8 7C8 6.20887 8.2346 5.43551 8.67412 4.77772C9.11365 4.11992 9.73836 3.60723 10.4693 3.30448C11.2002 3.00173 12.0044 2.92252 12.7804 3.07686C13.5563 3.2312 14.269 3.61216 14.8284 4.17157C15.3878 4.73098 15.7688 5.44371 15.9231 6.21964C16.0775 6.99556 15.9983 7.79983 15.6955 8.53073C15.3928 9.26163 14.8801 9.88635 14.2223 10.3259C13.5645 10.7654 12.7911 11 12 11C10.9391 11 9.92172 10.5786 9.17157 9.82842C8.42143 9.07828 8 8.06086 8 7ZM4 21C4 18.8783 4.84285 16.8434 6.34315 15.3431C7.84344 13.8428 9.87827 13 12 13C14.1217 13 16.1566 13.8428 17.6569 15.3431C19.1571 16.8434 20 18.8783 20 21H4Z" fill="#B0ACB3"/>
                                </svg>
                        </div>
                    </a>

                    
                </div>
            </div>
        </div>
        
        <div class="panel panel-left panel-reveal panel-resizable panel-init sidebar-left">
        <div class="page ">
            <div class="page-content">
            
                <h4 style="text-align: center;" class="title">Mobile Online Super Market</h4>
                <a href="#" class="panel-close"><i class="las la-times-circle"></i></a>
                <div class="nav-bar">
                    <ul>
                        <li class="active">
                            <a href="/home/">
                                <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M22.707 11.293L20.707 9.29298L12.707 1.29298C12.5195 1.10551 12.2652 1.0002 12 1.0002C11.7348 1.0002 11.4805 1.10551 11.293 1.29298L3.29301 9.29298L1.29301 11.293C1.11085 11.4816 1.01006 11.7342 1.01234 11.9964C1.01461 12.2586 1.11978 12.5094 1.30519 12.6948C1.4906 12.8802 1.74141 12.9854 2.00361 12.9877C2.26581 12.9899 2.51841 12.8891 2.70701 12.707L3.00001 12.414V22C3.00001 22.2652 3.10537 22.5196 3.2929 22.7071C3.48044 22.8946 3.73479 23 4.00001 23H20C20.2652 23 20.5196 22.8946 20.7071 22.7071C20.8947 22.5196 21 22.2652 21 22V12.414L21.293 12.707C21.4816 12.8891 21.7342 12.9899 21.9964 12.9877C22.2586 12.9854 22.5094 12.8802 22.6948 12.6948C22.8802 12.5094 22.9854 12.2586 22.9877 11.9964C22.99 11.7342 22.8892 11.4816 22.707 11.293ZM19 21H5.00001V10.414L12 3.41398L19 10.414V21Z" fill="#309F5F"/>
                                </svg>
                                <span>Accueil</span>
                            </a>
                        </li>


                        <li>
                            <a href="/check_profil/">
                                <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M15.7 11.717C16.6839 10.9476 17.4031 9.89041 17.7575 8.69276C18.1118 7.49511 18.0836 6.21673 17.6767 5.03589C17.2698 3.85506 16.5046 2.83063 15.4877 2.10546C14.4708 1.38028 13.253 0.990524 12.004 0.990524C10.755 0.990524 9.53719 1.38028 8.52031 2.10546C7.50342 2.83063 6.73819 3.85506 6.33131 5.03589C5.92443 6.21673 5.89619 7.49511 6.25053 8.69276C6.60487 9.89041 7.32413 10.9476 8.308 11.717C6.44917 12.4566 4.85467 13.7363 3.73027 15.391C2.60587 17.0457 2.00318 18.9994 2 21V22C2 22.2652 2.10536 22.5196 2.29289 22.7071C2.48043 22.8946 2.73478 23 3 23H21C21.2652 23 21.5196 22.8946 21.7071 22.7071C21.8946 22.5196 22 22.2652 22 22V21C21.9975 19.0003 21.3959 17.0473 20.273 15.3927C19.1501 13.7381 17.5573 12.4579 15.7 11.717ZM8 7C8 6.20887 8.2346 5.43551 8.67412 4.77772C9.11365 4.11992 9.73836 3.60723 10.4693 3.30448C11.2002 3.00173 12.0044 2.92252 12.7804 3.07686C13.5563 3.2312 14.269 3.61216 14.8284 4.17157C15.3878 4.73098 15.7688 5.44371 15.9231 6.21964C16.0775 6.99556 15.9983 7.79983 15.6955 8.53073C15.3928 9.26163 14.8801 9.88635 14.2223 10.3259C13.5645 10.7654 12.7911 11 12 11C10.9391 11 9.92172 10.5786 9.17157 9.82842C8.42143 9.07828 8 8.06086 8 7ZM4 21C4 18.8783 4.84285 16.8434 6.34315 15.3431C7.84344 13.8428 9.87827 13 12 13C14.1217 13 16.1566 13.8428 17.6569 15.3431C19.1571 16.8434 20 18.8783 20 21H4Z" fill="#B0ACB3"/>
                                </svg>
                                <span>Profil</span>
                            </a>
                        </li>


                    </ul>
                </div>
                <div class="sidebar-footer">
                    <h5 class="name">Mobile Online Super Market</h5>
                    <p>Version 1.2.1</p>
                </div>
            </div>
        </div>
    </div>
        <!-- Page Content -->
        <div class="page-content content-area pt-80 pb-5 infinite-scroll-content" @infinite=${loadMore}>
            
           
            
            <div class="container">

               

                <div id="map" style="height: 900px;width: 100%"></div>

                <div class="container" style="z-index: 9999">
                
                <!-- Search -->
                <form data-search-container=".search-list" data-search-in=".item-title" class="searchbar searchbar-init search-box list-search-bx">
                    <div class="searchbar-inner">
                        <div class="searchbar-input-wrap">
                            <input type="search"  placeholder="Rechercher un lieu ici..."/>
                            <i class="searchbar-icon">
                                <svg width="23" height="23" viewBox="0 0 23 23" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M22.707 21.293L17.6 16.182C19.1017 14.3173 19.8314 11.9479 19.6388 9.56147C19.4462 7.17505 18.3459 4.9533 16.5645 3.35365C14.7832 1.754 12.4563 0.898212 10.063 0.962481C7.66967 1.02675 5.39207 2.00618 3.69913 3.69913C2.00618 5.39207 1.02675 7.66967 0.962481 10.063C0.898212 12.4563 1.754 14.7832 3.35365 16.5645C4.9533 18.3459 7.17505 19.4462 9.56147 19.6388C11.9479 19.8314 14.3173 19.1017 16.182 17.6L21.293 22.711C21.4816 22.8931 21.7342 22.9939 21.9964 22.9917C22.2586 22.9894 22.5094 22.8842 22.6948 22.6988C22.8802 22.5134 22.9854 22.2626 22.9877 22.0004C22.9899 21.7382 22.8891 21.4856 22.707 21.297V21.293ZM2.99999 10.333C2.99999 8.88242 3.43015 7.46442 4.23606 6.25833C5.04197 5.05224 6.18745 4.11222 7.52762 3.55716C8.86779 3.0021 10.3425 2.85692 11.7651 3.13998C13.1878 3.42305 14.4946 4.12164 15.5203 5.14742C16.5459 6.1732 17.2443 7.48009 17.5272 8.90281C17.8101 10.3255 17.6647 11.8002 17.1094 13.1403C16.5542 14.4804 15.614 15.6257 14.4078 16.4315C13.2016 17.2372 11.7836 17.6672 10.333 17.667C8.38871 17.6646 6.52477 16.8911 5.15005 15.5162C3.77534 14.1413 3.00211 12.2773 2.99999 10.333Z" fill="#BFBFBF"/>
                                </svg>
                            </i>
                        </div>
                    </div>
                </form>
                <div class="list simple-list searchbar-not-found">
                    <ul>
                        <li>Aucun résultat</li>
                    </ul>
                </div>
                
            </div>

            </div>
            
            
        </div>
        
    </div>

</template>



<script>

    export default (props, { $,$on, $f7, $update }) => {
      // initialiser mes var

      var $ = Dom7;

      let toastIcon=null;
    let allowInfinite = true;
    let hasMoreItems = true;
    let lastItem=5;
    let feeds=null;
    let paginate_feed=null;
    let taille=0;
    let boutiques=null;

    var notifs=null;


    // const user_id=1;
    // const profil="client";

    const user_id="getId()";
    const profil="getProfil()";




    const topHome = () => {

        $('.page-content').scrollTop(0)
    };



    const loadMore = () => {

      if (!allowInfinite) return;
      allowInfinite = false;

      setTimeout(function () {
        if (lastItem >= taille) {
          hasMoreItems = false;
          $update();
          return;
        }

        for (var i = lastItem; i < lastItem+5; i++) {

          if(feeds[i]!==undefined){

            paginate_feed.push(feeds[i]);
          }
        }

        allowInfinite = true;
        lastItem += 5;

        $update();
      }, 1000);
    }


    const showToastIcon = (id,cpt) => {

        if(profil!=null){

            $f7.request.post(
                'http://mobileonlinesupermarket.com/api/like/'+user_id+'/'+id+"/"+profil,function(data) {
                    // Valider Avec Succès
            });

          $('.img_valide_'+id).attr('src', "assets/img/valide.png");
          
          $('.count_likes_'+id).attr('title', cpt+1);



          if (!toastIcon) {

            toastIcon = $f7.toast.create({
              icon: "<img src='assets/img/valide.png' width='50px' />",
              text: 'Je valide',
              position: 'center',
              closeTimeout: 2000,
            });
          }
          // Open it
          toastIcon.open();
      }else{

            Toast("Veuillez vous connecter pour valider");
      }
    }


    const downloadPost = (nom_boutique,date,description,on_off,content,file,commercant_id,localisation,id_boutique,heure_ouvert,media,pcouverture) => {

            /*Enregistrement*/

            Toast("Enregistré pour plutard !");

            saveDownload(nom_boutique, date, description, on_off, content, file, commercant_id, localisation,id_boutique,heure_ouvert,media,pcouverture);


    };



    const detailImg = (text) => {
      // 

       var myPhotoBrowserCaptions = $f7.photoBrowser.create({
        photos: [
          {
            url: "http://mobileonlinesupermarket.com/uploads/"+text+".jpg",
            caption: ''
          },
        ],
        theme: 'dark',
        type: 'standalone'
      });

        myPhotoBrowserCaptions.open();
     

    }








      $on('pageInit', () => {


            var map = L.map('map').setView([12.3499,-1.4904],13);
            var x = "12.4567890";
            var y = "-1.3456789";

            L.tileLayer('https://api.maptiler.com/maps/streets/{z}/{x}/{y}.png?key=oMB1ATTkNnTr6c8uoK6J', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">Africasys</a> contributors',
                maxZoom: 22,
                tileSize: 512,
                zoomOffset: -1
            }).addTo(map);

            L.marker([y,x]).addTo(map)



        if(profil!=""){


            $f7.request.get('http://mobileonlinesupermarket.com/api/notifs/'+profil+'/'+user_id ).then((res) => {
                notifs = res.data;
                notifs=JSON.parse(notifs);
                $update();

            }).catch(function (err) {
                });


        }




        $f7.request.get('http://mobileonlinesupermarket.com/api/publications').then((res) => {
            feeds = res.data;
            feeds=JSON.parse(feeds);
            taille=Object.keys(feeds).length;

            paginate_feed=feeds.slice(0,5);
            $update();

        }).catch(function (err) {
            feeds=0;
            taille=0;
            });



        $f7.request.get('http://mobileonlinesupermarket.com/api/getRandomBoutique').then((res) => {
            boutiques=JSON.parse(res.data);

            console.log(boutiques);
            
            $update();

        }).catch(function (err) {

        });




        $('#searchProduct').submit(function( event ) {

            var formData = $f7.form.convertToData('#searchProduct');
            var search=formData.search;

            event.preventDefault();

            $f7.views.main.router.navigate('/search/'+search);


        });




    });


          $on('pageBeforeRemove', () => {

      if (toastIcon) toastIcon.destroy();

    })




  return $render;
}

</script>

